apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: ingest-clinvar-release-e2e
spec:
  entrypoint: main
  serviceAccountName: {{ .Values.serviceAccount.k8sName }}
  templates:
    ##
    ## Entrypoint for end-to-end ETL of a ClinVar archive.
    ##
    ## Orchestrates calls to sub-workflows that know how to
    ## extract, transform, load, and publish the data.
    ##
    - name: main
      inputs:
        parameters:
          - name: jade-profile-id
          {{- $jadeProfileId := "{{inputs.parameters.jade-profile-id}}" }}
          - name: data-repo-url
          {{- $dataRepoUrl := "{{inputs.parameters.data-repo-url}}" }}
          - name: dataset-id
          {{- $datasetId := "{{inputs.parameters.dataset-id}}" }}
          - name: jade-dataset-name
          {{- $jadeDatasetName := "{{inputs.parameters.jade-dataset-name}}" }}
          - name: jade-data-project
          {{- $jadeDataProject := "{{inputs.parameters.jade-data-project}}" }}
          - name: archive-path
          {{- $archivePath := "{{inputs.parameters.archive-path}}" }}
          - name: gcs-prefix
          {{- $gcsPrefix := "{{inputs.parameters.gcs-prefix}}" }}
      dag:
        tasks:
          - name: ingest-archive
            templateRef:
              name: ingest-xml-archive
              template: main
            arguments:
              parameters:
                - name: jade-data-project
                  value: {{ $jadeDataProject | quote }}
                - name: data-repo-url
                  value: {{ $dataRepoUrl | quote }}
                - name: dataset-id
                  value: {{ $datasetId | quote }}
                - name: dataset-name
                  value: {{ $jadeDatasetName | quote }}
                - name: archive-path
                  value: {{ $archivePath | quote }}
                - name: gcs-prefix
                  value: {{ $gcsPrefix | quote }}
            {{- $releaseDate := "{{tasks.ingest-archive.outputs.parameters.release-date}}" }}

          - name: process-archive
            dependencies: [ingest-archive]
            templateRef:
              name: process-and-reingest-release
              template: main
            arguments:
              parameters:
                - name: data-repo-url
                  value: {{ $dataRepoUrl | quote }}
                - name: dataset-id
                  value: {{ $datasetId | quote }}
                - name: dataset-name
                  value: {{ $jadeDatasetName | quote }}
                - name: jade-data-project
                  value: {{ $jadeDataProject | quote }}
                - name: release-date
                  value: {{ $releaseDate | quote }}
                - name: gcs-prefix
                  value: {{ $gcsPrefix | quote }}
            {{- $datasetName := "{{tasks.process-archive.outputs.parameters.dataset-name}}" }}
          {{- $shouldExportDiff := printf "%t" .Values.steps.exportDiff.enabled }}

          - name: export-diff
            when: {{ printf "%s == true" $shouldExportDiff }}
            dependencies: [process-archive]
            templateRef:
              name: export-diff
              template: main
            arguments:
              parameters:
                - name: jade-profile-id
                  value: {{ $jadeProfileId | quote }}
                - name: jade-data-project
                  value: {{ $jadeDataProject | quote }}
                - name: jade-dataset-name
                  value: {{ $jadeDatasetName | quote }}
                - name: release-date
                  value: {{ $releaseDate | quote }}
                - name: dataset-name
                  value: {{ $datasetName | quote }}
                - name: gcs-prefix
                  value: {{ $gcsPrefix | quote }}
