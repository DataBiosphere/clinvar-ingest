apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: export-diff-standalone
spec:
  entrypoint: main
  serviceAccountName: {{ .Values.serviceAccount.k8sName }}
  templates:
    {{- $pipelineVersion := default "latest" .Values.version }}
    {{- $jadeDatasetName := "{{workflow.parameters.jade-dataset-name}}" }}

    ##
    ## Entrypoint for notifying clinvar of changes. Does so using Kafka.
    ##
    ##
    - name: main
      inputs:
        parameters:
          - name: release-date
          {{- $releaseDate := "{{inputs.parameters.release-date}}" }}
          - name: dataset-name
          {{- $datasetName := "{{inputs.parameters.dataset-name}}" }}
          - name: gcs-prefix
          {{- $gcsPrefix := "gs://broad-dsp-spec-ops/scratch/andrea/clinvar/" }}
      dag:
        tasks:
          ## Processes to run when the preceding date is present
          - name: diff-previous
            templateRef:
              name: date-present
              template: main
            withItems:
              - clinical_assertion
              - clinical_assertion_observation
              - clinical_assertion_trait
              - clinical_assertion_trait_set
              - clinical_assertion_variation
              - gene
              - gene_association
              - rcv_accession
              - submission
              - submitter
              - trait
              - trait_mapping
              - trait_set
              - variation
              - variation_archive
            arguments:
              parameters:
                - name: table-name
                  value: {{ "{{item}}" | quote }}
                - name: gcs-prefix
                  value: {{ $gcsPrefix | quote }}
                - name: release-date
                  value: {{ $releaseDate | quote }}
                - name: pipeline-version
                  value: {{ $pipelineVersion | quote}}
                - name: dataset-name
                  value: {{ $datasetName | quote }}